<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Meta Tags and Title -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YasaGeo & Tools Management App</title>

    <!-- External Fonts and Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" crossorigin="anonymous">

    <!-- Include SheetJS for Excel processing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>

    <!-- Chart.js for Data Visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Internal CSS for styling -->
    <style>
        /* General Styles */
        body, html {
            height: 100%;
            margin: 0;
            font-family: 'Orbitron', sans-serif;
            background-color: #0d0f14;
            color: #00ffff;
            overflow-x: hidden;
        }

        /* Video Background */
        #videoBackground {
            position: fixed;
            top: 50%;
            left: 50%;
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            transform: translate(-50%, -50%);
            z-index: -1;
            object-fit: cover;
            object-position: center;
        }

        /* Main Content Styles (always visible) */
        #mainContent {
            display: block;
            position: relative;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
            position: relative;
        }

        header .transparent-logo {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 50px;
            height: auto;
        }

        h1 {
            font-size: 3em;
            color: #00f7ff;
            margin: 0;
        }

        /* Tabs */
        .tab {
            overflow: hidden;
            background-color: rgba(0, 0, 0, 0.8);
            margin-bottom: 20px;
            border-radius: 10px;
            display: flex;
        }

        .tab button {
            background-color: inherit;
            color: white;
            flex: 1;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 0;
            font-size: 16px;
            transition: 0.3s;
            text-align: center;
        }

        .tab button:hover {
            background-color: #005f5e;
        }

        .tab button.active {
            background-color: #005f5e;
        }

        /* Tab Content */
        .tabcontent {
            display: none;
            padding: 20px;
            border-radius: 15px;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            box-shadow: 0 0 30px 15px rgba(0, 255, 255, 0.2),
                        inset 0 0 20px rgba(0, 255, 255, 0.1);
            border: 1px solid rgba(0, 255, 255, 0.2);
        }

        .active-content {
            display: block;
        }

        /* Tool Widgets Container */
        .tool-widgets-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            justify-items: center;
            padding: 10px;
            margin: 0 auto;
        }

        /* Tool Widget */
        .tool-widget {
            position: relative;
            width: 100%;
            max-width: 180px;
            background-color: rgba(0, 0, 0, 0.5);
            color: #00ffea;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            font-size: 14px;
            line-height: 1.4;
            overflow: hidden;
            box-sizing: border-box;
            border: 1px solid rgba(0, 255, 255, 0.2);
            box-shadow: 0 0 10px 3px rgba(0, 255, 255, 0.2),
                        inset 0 0 5px rgba(0, 255, 255, 0.1);
            transition: background-color 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }

        .tool-widget:hover {
            background-color: #005f5e;
            box-shadow: 0 0 15px 4px rgba(0, 255, 255, 0.4),
                        inset 0 0 10px rgba(0, 255, 255, 0.2);
        }

        /* Condition-based Glow Colors */
        .tool-widget.critical {
            box-shadow: 0 0 10px 3px rgba(255, 0, 0, 0.4),
                        inset 0 0 5px rgba(255, 0, 0, 0.2);
            border: 1px solid rgba(255, 0, 0, 0.4);
            background-color: rgba(255, 0, 0, 0.2);
            color: #ffcccc;
        }

        .tool-widget.warning {
            box-shadow: 0 0 10px 3px rgba(255, 255, 0, 0.4),
                        inset 0 0 5px rgba(255, 255, 0, 0.2);
            border: 1px solid rgba(255, 255, 0, 0.4);
            background-color: rgba(255, 255, 0, 0.2);
            color: #ffffcc;
        }

        /* Tool Icon */
        .tool-icon img {
            width: 100%;
            height: auto;
            border-radius: 10px;
            object-fit: cover;
            margin-bottom: 10px;
        }

        /* Tool Widget Content */
        .tool-widget-content {
            flex: 1;
        }

        /* Popup Styles */
        .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 500px;
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.9);
            color: #00ffea;
            border-radius: 10px;
            max-height: 80vh;
            overflow-y: auto;
            box-sizing: border-box;
            z-index: 1000;
        }

        .popup.active {
            display: block;
        }

        .popup-header {
            font-size: 1.8em;
            margin-bottom: 20px;
            text-align: center;
        }

        .popup-content p {
            margin: 10px 0;
        }

        .popup-close {
            background-color: #00ffea;
            color: #1d1f20;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 1em;
            transition: background-color 0.3s;
            display: block;
            margin: 20px auto 0;
        }

        .popup-close:hover {
            background-color: #00e5e5;
        }

        /* Button Container */
        .button-wrapper {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin: 20px 0;
            gap: 15px;
        }

        .button-container button {
            background: linear-gradient(90deg, #e0ff00, #00ff7f);
            color: #333;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: transform 0.2s, box-shadow 0.2s, background 0.3s;
        }

        .button-container button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            background: linear-gradient(90deg, #00ff7f, #e0ff00);
        }

        .button-container button:active {
            transform: translateY(1px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        /* Chat Styles */
        #chatContainer {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            max-height: 400px;
            background-color: rgba(0, 0, 0, 0.9);
            color: #00ffff;
            border-radius: 10px;
            padding: 10px;
            overflow-y: auto;
            display: none;
            z-index: 1001;
        }

        #chatContainer.active {
            display: block;
        }

        #chatMessages {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 10px;
        }

        #chatMessages .chat-message {
            margin-bottom: 5px;
        }

        #chatInput {
            width: calc(100% - 70px);
            padding: 10px;
            border: none;
            border-radius: 5px;
            outline: none;
            background-color: #1d1f20;
            color: #00ffff;
        }

        #sendChatButton {
            padding: 10px;
            border: none;
            border-radius: 5px;
            background-color: #00ffea;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-left: 5px;
        }

        #sendChatButton:hover {
            background-color: #00e5e5;
        }

        .clear-chat {
            margin-top: 10px;
            background-color: #ff4c4c;
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            color: #1d1f20;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .clear-chat:hover {
            background-color: #ff1a1a;
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .tool-widgets-container {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }

            .button-container button {
                padding: 10px 20px;
                font-size: 14px;
            }

            #chatContainer {
                width: 90%;
                right: 5%;
            }
        }

        @media (max-width: 480px) {
            .tool-widgets-container {
                grid-template-columns: repeat(2, 1fr);
            }

            .tool-widget {
                max-width: 100%;
            }
        }

        /* Optional About Us Modal (if you want to show it) */
        .modal-background {
            position: fixed;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            display: none;
            z-index: 9999;
            background-color: rgba(0, 0, 0, 0.8);
        }

        .modal-background.active {
            display: block;
        }

        .modal-content {
            background-color: #111;
            color: #00ffff;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            max-width: 400px;
            text-align: center;
        }

        .modal-content h2 {
            margin-top: 0;
        }

        .close-modal-btn {
            background-color: #00ffea;
            color: #1d1f20;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
        }

        .close-modal-btn:hover {
            background-color: #00e5e5;
        }
    </style>
</head>
<body>
    <!-- Video Background -->
    <video autoplay muted loop playsinline id="videoBackground">
        <source src="https://storage.googleapis.com/yasatmapi/2792370-hd_1920_1080_30fps.mp4" type="video/mp4">
        Your browser does not support the video tag.
    </video>

    <!-- Main Content -->
    <div id="mainContent">
        <header>
            <img src="https://storage.googleapis.com/jsonyasa/2Yasalogh.gif" alt="Logo" class="transparent-logo">
            <h1>Yasa Georgia TM APP</h1>
        </header>

        <!-- Tabs -->
        <nav class="tab">
            <button class="tablinks active" onclick="openTab(event, 'machinesTab')">Machines Overview</button>
            <button class="tablinks" onclick="openTab(event, 'toolsTab')">Tools Settings</button>
            <button class="tablinks" onclick="openTab(event, 'toolHoldersTab')">Tool Holders</button>
        </nav>

        <!-- Main Container -->
        <main class="container">
            <!-- Machines Overview Tab -->
            <section id="machinesTab" class="tabcontent active-content">
                <h2>Machines Overview</h2>
                <div id="toolWidgets" class="tool-widgets-container"></div>
                <canvas id="toolChart" width="400" height="200"></canvas>
            </section>

            <!-- Tools Settings Tab -->
            <section id="toolsTab" class="tabcontent">
                <h2>Tools Settings</h2>
                <!-- Search and Sort Functionality -->
                <div class="tool-filters" style="margin-bottom: 15px;">
                    <input type="text" id="toolSearchInput" placeholder="Search tools..." oninput="searchTools()" style="width: 60%; padding: 5px; border-radius: 5px; border: none;">
                    <select id="sortOptions" onchange="sortTools()" style="width: 35%; padding: 5px; border-radius: 5px; border: none;">
                        <option value="">Sort By</option>
                        <option value="Tool Number">Tool Number</option>
                        <option value="Total Quantity">Total Quantity</option>
                    </select>
                </div>
                <div id="toolList"></div>
                <div class="import-export" style="margin-top: 20px;">
                    <h3>Import Tool Library</h3>
                    <input type="file" id="toolLibraryFile" accept=".xlsx">
                    <button type="button" onclick="importToolLibrary()">Import</button>
                    <button class="export-btn" onclick="exportToExcel()">Export to Excel</button>
                </div>
            </section>

            <!-- Tool Holders Tab -->
            <section id="toolHoldersTab" class="tabcontent">
                <h2>Tool Holders</h2>
                <div id="toolHolderWidgetsContainer" class="tool-widgets-container"></div>
                <button onclick="addToolHolder()">Add Tool Holder</button>
            </section>
        </main>

        <!-- Popup for Tool Details -->
        <div id="toolPopup" class="popup">
            <div class="popup-header" id="toolPopupHeader"></div>
            <div class="popup-content" id="toolPopupContent"></div>
            <button class="popup-close" onclick="closePopup()">Close</button>
        </div>

        <!-- Button Container -->
        <div class="button-wrapper">
            <div class="button-container">
                <button onclick="exportToolData()"><i class="fas fa-file-export"></i> Export All Tool Data</button>
                <button onclick="loadToolDataFromCloud()"><i class="fas fa-cloud-download-alt"></i> Load Data from Cloud</button>
                <button onclick="saveToolDataToCloud(true)"><i class="fas fa-cloud-upload-alt"></i> Save Changes to Cloud</button>
                <button onclick="createTool()"><i class="fas fa-plus-circle"></i> Create Tool</button>
                <button onclick="exportToolConditionsToExcel()"><i class="fas fa-file-excel"></i> Export Tool Conditions to Excel</button>
                <button onclick="toggleChat()"><i class="fas fa-comments"></i> Chat</button>
                <button onclick="openAboutUs()"><i class="fas fa-info-circle"></i> About Us</button>
            </div>
        </div>

        <!-- Chat Container -->
        <div id="chatContainer">
            <h3>Chat</h3>
            <div id="chatMessages"></div>
            <div style="display: flex;">
                <input type="text" id="chatInput" placeholder="Type a message..." onkeydown="if(event.key === 'Enter') sendMessage()">
                <button id="sendChatButton" onclick="sendMessage()">Send</button>
            </div>
            <button onclick="clearChat()" class="clear-chat">Clear Chat</button>
        </div>
    </div>

    <!-- Optional About Us Modal -->
    <div id="aboutUsModal" class="modal-background">
        <div class="modal-content">
            <h2>About Us</h2>
            <p>This is the Yasa Georgia TM APP. Here you can manage tools, holders, and much more!</p>
            <button class="close-modal-btn" onclick="closeAboutUs()">Close</button>
        </div>
    </div>

    <script>
        /* ---------- Configuration / Global Variables ---------- */
        const TOOLS_API_URL = 'https://github.com/Qourum/Yasamap/blob/233cb0422cafd4e01e87a6495982cff285aea997/11111.json';  // Updated link
        const BACKEND_API_URL = 'https://github.com/Qourum/Yasamap/blob/233cb0422cafd4e01e87a6495982cff285aea997/11111.json'; // Placeholder for your own backend if needed

        let tools = [];
        let toolHolders = [];
        let chatHistory = [];
        let isSaving = false;

        /* ---------- Basic Tool Loading from JSON32 ---------- */
        async function loadTools() {
            try {
                const response = await fetch(TOOLS_API_URL);
                if (!response.ok) throw new Error(`Failed to load tools: ${response.statusText}`);
                const data = await response.json();
                tools = data.tools || [];
                // If the JSON has toolHolders, load them too
                toolHolders = data.toolHolders || [];
                displayTools();
                createToolWidgets();
                createToolHolderWidgets();
                createToolChart();
            } catch (error) {
                console.error(error);
            }
        }

        // Display a quick, minimal listing
        function displayTools() {
            const toolList = document.getElementById('toolList');
            toolList.innerHTML = '';
            tools.forEach(tool => {
                const div = document.createElement('div');
                div.innerHTML = `
                    <p><strong>Tool Number:</strong> ${tool['Tool Number']}</p>
                    <p><strong>Manufacturer:</strong> ${tool['Tool Manufacturer']}</p>
                    <p><strong>Total Quantity:</strong> ${tool['Total Quantity']}</p>
                    <hr>
                `;
                toolList.appendChild(div);
            });
        }

        /* ---------- Detailed UI and CRUD for Tools ---------- */
        function createToolWidgets() {
            const toolWidgetsContainer = document.getElementById('toolWidgets');
            toolWidgetsContainer.innerHTML = '';
            tools.forEach((tool, index) => {
                const availableOnShelf = calculateAvailable(tool);
                const widget = document.createElement('div');
                widget.classList.add('tool-widget');

                // Condition-based styling
                if (availableOnShelf <= tool['Critical Quantity']) {
                    widget.classList.add('critical');
                } else if (availableOnShelf <= tool['Critical Quantity'] + 2) {
                    widget.classList.add('warning');
                }

                widget.innerHTML = `
                    <div class="tool-icon">
                        <img src="${tool['Image'] || 'https://via.placeholder.com/150'}" alt="Tool Image">
                    </div>
                    <div class="tool-widget-content">
                        <div><strong>${tool['Tool Number']}</strong></div>
                        <div>Total Quantity: ${tool['Total Quantity']}</div>
                        <div>Available on Shelf: ${availableOnShelf}</div>
                    </div>
                `;

                widget.addEventListener('click', () => openToolPopup(index));
                toolWidgetsContainer.appendChild(widget);
            });
        }

        function createToolList(filteredTools = tools) {
            const toolListContainer = document.getElementById('toolList');
            toolListContainer.innerHTML = '';
            filteredTools.forEach((tool, index) => {
                const availableOnShelf = calculateAvailable(tool);
                const toolListItem = document.createElement('div');
                toolListItem.classList.add('tool-list-item');
                toolListItem.style.display = 'flex';
                toolListItem.style.justifyContent = 'space-between';
                toolListItem.style.padding = '10px';
                toolListItem.style.borderBottom = '1px solid rgba(255, 255, 255, 0.1)';

                toolListItem.innerHTML = `
                    <div>
                        <p><strong>Tool Number:</strong> ${tool['Tool Number']}</p>
                        <p><strong>Total Quantity:</strong> ${tool['Total Quantity']}</p>
                        <p><strong>Available on Shelf:</strong> ${availableOnShelf}</p>
                        <p><strong>Internet Resources:</strong>
                            <a href="${tool['Internet Resources'] || '#'}"
                               onclick="copyToClipboard('${tool['Internet Resources'] || ''}'); return false;">
                                ${tool['Internet Resources'] ? 'Copy Link' : 'No Link'}
                            </a>
                        </p>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 5px;">
                        <button onclick="renameTool(${index})">Rename</button>
                        <button onclick="deleteTool(${index})">Delete</button>
                    </div>
                `;

                // Click anywhere else in the item to open popup
                toolListItem.addEventListener('click', (e) => {
                    if (!e.target.tagName.toLowerCase().includes('button') &&
                        !e.target.tagName.toLowerCase().includes('a')) {
                        openToolSettingsPopup(index);
                    }
                });

                toolListContainer.appendChild(toolListItem);
            });
        }

        // Searching
        function searchTools() {
            const searchInput = document.getElementById('toolSearchInput').value.toLowerCase();
            const filteredTools = tools.filter(tool => {
                return (
                    tool['Tool Number'].toLowerCase().includes(searchInput) ||
                    tool['Tool Manufacturer'].toLowerCase().includes(searchInput)
                );
            });
            createToolList(filteredTools);
        }

        // Sorting
        function sortTools() {
            const sortBy = document.getElementById('sortOptions').value;
            let sortedTools = [...tools];

            if (sortBy === 'Tool Number') {
                sortedTools.sort((a, b) => a['Tool Number'].localeCompare(b['Tool Number']));
            } else if (sortBy === 'Total Quantity') {
                sortedTools.sort((a, b) => b['Total Quantity'] - a['Total Quantity']);
            }
            createToolList(sortedTools);
        }

        // Calculate Available = Total - (sharpening + broken + in-machines)
        function calculateAvailable(tool) {
            const totalQuantity = parseInt(tool['Total Quantity']) || 0;
            const sharpening = parseInt(tool['Sharpening']) || 0;
            const broken = parseInt(tool['Broken']) || 0;

            let hellerSiemens = 0;
            let okuma5ax = 0;
            let okumaGenos5ax = 0;
            if (tool.Machines) {
                hellerSiemens = parseInt(tool.Machines['Heller Siemens']) || 0;
                okuma5ax     = parseInt(tool.Machines['Okuma 5ax']) || 0;
                okumaGenos5ax= parseInt(tool.Machines['Okuma Genos 5ax']) || 0;
            }
            return totalQuantity - (sharpening + broken + hellerSiemens + okuma5ax + okumaGenos5ax);
        }

        // Copy link to clipboard
        function copyToClipboard(text) {
            if (text) {
                navigator.clipboard.writeText(text)
                    .then(() => { alert('Link copied to clipboard!'); })
                    .catch(err => { console.error('Failed to copy text: ', err); });
            } else {
                alert('No link available to copy.');
            }
        }

        /* ---------- Popup / Editing Tools ---------- */
        function openToolPopup(index) {
            const tool = tools[index];
            const toolPopupHeader = document.getElementById('toolPopupHeader');
            const toolPopupContent = document.getElementById('toolPopupContent');

            toolPopupHeader.textContent = `Tool Number: ${tool['Tool Number']}`;
            toolPopupContent.innerHTML = `
                <p><strong>Manufacturer:</strong>
                   <input type="text" value="${tool['Tool Manufacturer']}" onchange="updateTool(${index}, 'Tool Manufacturer', this.value)">
                </p>
                <p><strong>Total Quantity:</strong>
                   <input type="number" value="${tool['Total Quantity']}" onchange="updateTool(${index}, 'Total Quantity', this.value)">
                </p>
                <p><strong>Sharpening:</strong>
                   <input type="number" value="${tool['Sharpening'] || 0}" onchange="updateTool(${index}, 'Sharpening', this.value)">
                </p>
                <p><strong>Broken:</strong>
                   <input type="number" value="${tool['Broken'] || 0}" onchange="updateTool(${index}, 'Broken', this.value)">
                </p>
                <p><strong>Critical Quantity:</strong>
                   <input type="number" value="${tool['Critical Quantity'] || 1}" onchange="updateTool(${index}, 'Critical Quantity', this.value)">
                </p>
                <p><strong>Internet Resources:</strong>
                   <input type="url" value="${tool['Internet Resources'] || ''}" onchange="updateTool(${index}, 'Internet Resources', this.value)">
                </p>
                <h4>Machine-Specific Quantities</h4>
                <p><strong>Heller Siemens (HSK):</strong>
                   <input type="number" value="${tool.Machines?.['Heller Siemens'] || 0}" onchange="updateToolMachine(${index}, 'Heller Siemens', this.value)">
                </p>
                <p><strong>Okuma 5ax (MK-40):</strong>
                   <input type="number" value="${tool.Machines?.['Okuma 5ax'] || 0}" onchange="updateToolMachine(${index}, 'Okuma 5ax', this.value)">
                </p>
                <p><strong>Okuma Genos 5ax (SK-40):</strong>
                   <input type="number" value="${tool.Machines?.['Okuma Genos 5ax'] || 0}" onchange="updateToolMachine(${index}, 'Okuma Genos 5ax', this.value)">
                </p>
                <p><strong>Upload Image:</strong>
                   <input type="file" onchange="uploadToolImage(${index}, this)" accept="image/*">
                </p>
                ${
                    tool['Image']
                    ? `<img src="${tool['Image']}" alt="Tool Image" style="max-width:100%; border-radius:10px; margin-top:10px;">`
                    : '<p>No Image Available</p>'
                }
                <button onclick="saveChanges(${index})" style="margin-top: 10px;">Save Changes</button>
            `;
            document.getElementById('toolPopup').classList.add('active');
        }

        function openToolSettingsPopup(index) {
            openToolPopup(index);
        }

        function updateTool(index, property, value) {
            tools[index][property] = value;
        }

        function updateToolMachine(index, machine, value) {
            if (!tools[index].Machines) {
                tools[index].Machines = {};
            }
            tools[index].Machines[machine] = parseInt(value) || 0;
        }

        async function saveChanges(index) {
            await saveToolDataToBackend(true); // Manual save
            createToolWidgets();  // Refresh
            createToolList();     // Refresh
            createToolChart();    // Refresh
            alert('Changes saved successfully!');
            closePopup();
        }

        function closePopup() {
            document.getElementById('toolPopup').classList.remove('active');
        }

        // Rename tool
        async function renameTool(index) {
            const newToolNumber = prompt('Enter new Tool Number:', tools[index]['Tool Number']);
            if (newToolNumber) {
                tools[index]['Tool Number'] = newToolNumber;
                await saveToolDataToBackend(true);
                createToolWidgets();
                createToolList();
                createToolChart();
                alert('Tool renamed successfully!');
            }
        }

        // Delete tool
        async function deleteTool(index) {
            if (confirm('Are you sure you want to delete this tool?')) {
                tools.splice(index, 1);
                await saveToolDataToBackend(true);
                createToolWidgets();
                createToolList();
                createToolChart();
                alert('Tool deleted successfully!');
            }
        }

        /* ---------- Creating a New Tool ---------- */
        async function createTool() {
            const toolNumber = prompt('Enter Tool Number (e.g., T100):');
            if (!toolNumber) return;
            const newTool = {
                'Tool Number': toolNumber,
                'Tool Manufacturer': 'Unknown',
                'Total Quantity': 0,
                'Sharpening': 0,
                'Broken': 0,
                'Critical Quantity': 1,
                'Machines': {
                    'Heller Siemens': 0,
                    'Okuma 5ax': 0,
                    'Okuma Genos 5ax': 0
                },
                'Type': 'General',
                'Image': '',
                'Internet Resources': ''
            };
            tools.push(newTool);
            await saveToolDataToBackend(true);
            createToolWidgets();
            createToolList();
            createToolChart();
            alert('New tool created successfully!');
        }

        /* ---------- Tool Holder Management ---------- */
        function createToolHolderWidgets() {
            const container = document.getElementById('toolHolderWidgetsContainer');
            container.innerHTML = '';

            if (toolHolders.length === 0) {
                container.innerHTML = '<p>No tool holders available. Add a new tool holder.</p>';
                return;
            }

            toolHolders.forEach((holder, index) => {
                const widget = document.createElement('div');
                widget.classList.add('tool-widget');
                widget.innerHTML = `
                    <div class="tool-icon">
                        ${
                            holder.image
                            ? `<img src="${holder.image}" alt="Holder Image" style="width:100%; border-radius:10px;">`
                            : '<p>No Image</p>'
                        }
                    </div>
                    <div class="tool-widget-content">
                        <div><strong>Name:</strong> ${holder.name}</div>
                        <div><strong>Type:</strong> ${holder.type}</div>
                        <div><strong>Manufacturer:</strong> ${holder.manufacturer}</div>
                    </div>
                    <div style="display: flex; gap: 5px; margin-top: 10px;">
                        <button onclick="editToolHolder(${index})">Edit</button>
                        <button onclick="deleteToolHolder(${index})">Delete</button>
                    </div>
                `;
                container.appendChild(widget);
            });
        }

        async function addToolHolder() {
            const name = prompt('Enter Tool Holder Name:') || 'Unnamed';
            const type = prompt('Enter Tool Holder Type:') || 'Unknown';
            const manufacturer = prompt('Enter Tool Holder Manufacturer:') || 'No Manufacturer';
            const imageURL = prompt('Enter Image URL (or leave blank for default):') || '';

            const newHolder = { name, type, manufacturer, image: imageURL };
            toolHolders.push(newHolder);
            createToolHolderWidgets();
            await saveToolDataToBackend(true);
            alert('New tool holder added successfully!');
        }

        async function editToolHolder(index) {
            const holder = toolHolders[index];
            const newName = prompt('Edit Tool Holder Name:', holder.name) || holder.name;
            const newType = prompt('Edit Tool Holder Type:', holder.type) || holder.type;
            const newManufacturer = prompt('Edit Tool Holder Manufacturer:', holder.manufacturer) || holder.manufacturer;
            const newImageURL = prompt('Edit Image URL:', holder.image) || holder.image;

            toolHolders[index] = {
                name: newName,
                type: newType,
                manufacturer: newManufacturer,
                image: newImageURL
            };
            createToolHolderWidgets();
            await saveToolDataToBackend(true);
            alert('Tool holder updated successfully!');
        }

        async function deleteToolHolder(index) {
            if (confirm('Are you sure you want to delete this tool holder?')) {
                toolHolders.splice(index, 1);
                createToolHolderWidgets();
                await saveToolDataToBackend(true);
                alert('Tool holder deleted successfully!');
            }
        }

        /* ---------- Export / Import Functions ---------- */
        function exportToolConditionsToExcel() {
            const exportData = tools.map(tool => ({
                'Tool Number': tool['Tool Number'],
                'Tool Manufacturer': tool['Tool Manufacturer'],
                'Total Quantity': tool['Total Quantity'],
                'Sharpening': tool['Sharpening'],
                'Broken': tool['Broken'],
                'Critical Quantity': tool['Critical Quantity'],
                'Machines Used': JSON.stringify(tool.Machines),
                'Available on Shelf': calculateAvailable(tool),
                'Internet Resources': tool['Internet Resources'] || 'N/A',
                'Image': tool['Image'] ? 'Yes' : 'No'
            }));
            const worksheet = XLSX.utils.json_to_sheet(exportData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Tool Conditions');
            XLSX.writeFile(workbook, 'tool_conditions.xlsx');
        }

        function exportToolData() {
            const exportData = {
                tools: tools,
                toolHolders: toolHolders,
                chatHistory: chatHistory
            };
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'all_tool_data.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportToExcel() {
            exportToolConditionsToExcel();
        }

        async function importToolLibrary() {
            const fileInput = document.getElementById('toolLibraryFile');
            const file = fileInput.files[0];
            if (!file) {
                alert('Please select an Excel file to import.');
                return;
            }
            const reader = new FileReader();
            reader.onload = async function(e) {
                const data = e.target.result;
                const workbook = XLSX.read(data, { type: 'binary' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const importedTools = XLSX.utils.sheet_to_json(worksheet);

                importedTools.forEach(tool => {
                    tools.push({
                        'Tool Number': tool['Tool Number'] || 'N/A',
                        'Tool Manufacturer': tool['Tool Manufacturer'] || 'Unknown',
                        'Total Quantity': parseInt(tool['Total Quantity']) || 0,
                        'Sharpening': parseInt(tool['Sharpening']) || 0,
                        'Broken': parseInt(tool['Broken']) || 0,
                        'Critical Quantity': parseInt(tool['Critical Quantity']) || 1,
                        'Machines': {
                            'Heller Siemens': parseInt(tool['Heller Siemens']) || 0,
                            'Okuma 5ax': parseInt(tool['Okuma 5ax']) || 0,
                            'Okuma Genos 5ax': parseInt(tool['Okuma Genos 5ax']) || 0
                        },
                        'Type': tool['Type'] || 'General',
                        'Image': tool['Image'] || 'https://via.placeholder.com/150',
                        'Internet Resources': tool['Internet Resources'] || ''
                    });
                });
                createToolWidgets();
                createToolList();
                await saveToolDataToBackend(true);
                alert('Tool library imported successfully!');
            };
            reader.readAsBinaryString(file);
        }

        /* ---------- Image Upload (Requires Signed URL or Server) ---------- */
        async function uploadToolImage(index, input) {
            const file = input.files[0];
            if (!file) {
                alert('No image file selected!');
                return;
            }
            const imageName = `tool_${Date.now()}_${file.name}`;
            const uploadUrl = `https://storage.googleapis.com/jsonyasa/${imageName}`;
            const reader = new FileReader();
            reader.onload = async function(e) {
                const arrayBuffer = e.target.result;
                try {
                    const response = await fetch(uploadUrl, {
                        method: 'PUT',
                        headers: { 'Content-Type': file.type },
                        body: arrayBuffer
                    });
                    if (!response.ok) {
                        throw new Error(`Upload failed with status: ${response.status}`);
                    }
                    alert(`Image uploaded successfully as ${imageName}`);
                    tools[index]['Image'] = uploadUrl;
                    createToolWidgets();
                    createToolList();
                    await saveToolDataToBackend(true);
                } catch (error) {
                    console.error('Error uploading image:', error);
                    alert('Failed to upload image. Please check the console for more details.');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        /* ---------- Chart.js Integration ---------- */
        function createToolChart() {
            if (typeof Chart === 'undefined') {
                console.error('Chart.js is not loaded.');
                return;
            }
            const ctx = document.getElementById('toolChart').getContext('2d');
            if (window.toolChartInstance) {
                window.toolChartInstance.destroy();
            }
            const toolNumbers = tools.map(tool => tool['Tool Number']);
            const availableQuantities = tools.map(tool => calculateAvailable(tool));
            const totalQuantities = tools.map(tool => parseInt(tool['Total Quantity']) || 0);

            window.toolChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: toolNumbers,
                    datasets: [
                        {
                            label: 'Available Quantity',
                            data: availableQuantities,
                            backgroundColor: 'rgba(0, 255, 234, 0.6)',
                        },
                        {
                            label: 'Total Quantity',
                            data: totalQuantities,
                            backgroundColor: 'rgba(0, 123, 255, 0.6)',
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: { beginAtZero: true },
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        /* ---------- Tab Switching Function ---------- */
        function openTab(evt, tabName) {
            const tabContents = document.getElementsByClassName("tabcontent");
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].style.display = "none";
                tabContents[i].classList.remove("active-content");
            }
            const tabLinks = document.getElementsByClassName("tablinks");
            for (let i = 0; i < tabLinks.length; i++) {
                tabLinks[i].classList.remove("active");
            }
            document.getElementById(tabName).style.display = "block";
            document.getElementById(tabName).classList.add("active-content");
            evt.currentTarget.classList.add("active");
            if (tabName === 'machinesTab') {
                createToolChart();
            }
        }

        /* ---------- Chat Functions ---------- */
        function toggleChat() {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.classList.toggle('active');
            if (chatContainer.classList.contains('active')) {
                loadChatHistoryFromBackend(); 
            }
        }

        async function sendMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            // Since no login: just use a default user name
            const loggedInUser = 'Guest';
            if (message) {
                const chatEntry = { user: loggedInUser, message: message };
                chatHistory.push(chatEntry);
                await saveChatHistoryToBackend(chatHistory);
                renderChatHistory();
                chatInput.value = '';
            }
        }

        async function clearChat() {
            if (confirm('Are you sure you want to clear the chat history?')) {
                chatHistory = [];
                await saveChatHistoryToBackend(chatHistory);
                renderChatHistory();
            }
        }

        function renderChatHistory() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            chatHistory.forEach(chat => {
                const messageElement = document.createElement('div');
                messageElement.textContent = `${chat.user}: ${chat.message}`;
                messageElement.classList.add('chat-message');
                chatMessages.appendChild(messageElement);
            });
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        /* ---------- Backend Chat Persistence (Optional) ---------- */
        async function loadChatHistoryFromBackend() {
            // Example: fetch chat from your own server
            // (If you don't have a backend, comment this out or leave as no-op)
            try {
                const response = await fetch(`${BACKEND_API_URL}/data`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include'
                });
                if (!response.ok) {
                    throw new Error(`Failed to load chat history: ${response.statusText}`);
                }
                const data = await response.json();
                chatHistory = data.chatHistory || [];
                renderChatHistory();
            } catch (error) {
                console.error('Error loading chat history:', error);
            }
        }

        async function saveChatHistoryToBackend(history) {
            if (isSaving) {
                console.log('Save already in progress. Please wait.');
                return;
            }
            isSaving = true;
            try {
                const dataToSave = { tools, toolHolders, chatHistory: history };
                const response = await fetch(`${BACKEND_API_URL}/data`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(dataToSave)
                });
                if (!response.ok) {
                    throw new Error(`Failed to save chat history: ${response.statusText}`);
                }
            } catch (error) {
                console.error('Error saving chat history:', error);
            } finally {
                isSaving = false;
            }
        }

        /* ---------- Cloud Data Load & Save (Tools + Chat) ---------- */
        async function loadToolDataFromCloud() {
            try {
                const response = await fetch(`${BACKEND_API_URL}/data`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include'
                });
                if (!response.ok) {
                    throw new Error(`Failed to load tool data: ${response.statusText}`);
                }
                const data = await response.json();
                tools = data.tools || [];
                toolHolders = data.toolHolders || [];
                chatHistory = data.chatHistory || [];
                createToolWidgets();
                createToolList();
                createToolHolderWidgets();
                renderChatHistory();
                createToolChart();
                alert('Data loaded from cloud successfully!');
            } catch (error) {
                console.error('Error loading tool data:', error);
                alert('Failed to load data from cloud.');
            }
        }

        async function saveToolDataToCloud(isManualSave = false) {
            await saveToolDataToBackend(isManualSave);
        }

        async function saveToolDataToBackend(isManualSave = false) {
            if (isSaving) {
                console.log('Save already in progress. Please wait.');
                return;
            }
            isSaving = true;
            try {
                const dataToSave = { tools, toolHolders, chatHistory };
                const response = await fetch(`${BACKEND_API_URL}/data`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(dataToSave)
                });
                if (!response.ok) {
                    throw new Error(`Failed to save tool data: ${response.statusText}`);
                }
                if (isManualSave) {
                    alert('Data has been successfully saved to the cloud!');
                }
            } catch (error) {
                console.error('Error saving tool data:', error);
                alert('Failed to save data to cloud.');
            } finally {
                isSaving = false;
            }
        }

        /* ---------- About Us Modal ---------- */
        function openAboutUs() {
            document.getElementById('aboutUsModal').classList.add('active');
        }

        function closeAboutUs() {
            document.getElementById('aboutUsModal').classList.remove('active');
        }

        window.onclick = function(event) {
            const aboutUsModal = document.getElementById('aboutUsModal');
            if (event.target === aboutUsModal) {
                aboutUsModal.classList.remove('active');
            }
            const toolPopup = document.getElementById('toolPopup');
            if (event.target === toolPopup) {
                toolPopup.classList.remove('active');
            }
        };

        /* ---------- Initialize on Page Load ---------- */
        window.addEventListener('load', () => {
            // Load local JSON for Tools (no login required)
            loadTools();
        });
    </script>
</body>
  </html>
